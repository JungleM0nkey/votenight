{% extends "base.html" %}

{% block title %}Admin Panel - Movienite Votehub{% endblock %}

{% block content %}
<div class="container mx-auto py-6 space-y-6">
    <!-- Header -->
    <div class="card">
        <div class="card-content">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-900">Admin Control Panel</h1>
                <a href="{{ url_for('index', user=current_user.username) }}" class="btn btn-secondary">
                    <i class="fa fa-arrow-left mr-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Admin Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Users Table -->
        <div class="card">
            <div class="card-header flex items-center justify-between">
                <h2 class="text-xl font-semibold">Users</h2>
                <div class="flex gap-2">
                    <button id="refresh-votes" class="btn btn-ghost btn-sm" title="Reset all votes">
                        <i class="fa fa-sync-alt mr-1"></i> Reset Votes
                    </button>
                    <button id="refresh-points" class="btn btn-ghost btn-sm" title="Reset all points">
                        <i class="fa fa-sync-alt mr-1"></i> Reset Points
                    </button>
                </div>
            </div>
            <div class="card-content p-0">
                <div class="overflow-x-auto">
                    <table class="table" id="users-table">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Last Vote</th>
                                <th>Points</th>
                                <th>Email</th>
                                <th>User Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for object in user_objects %}
                            <tr class="hover:bg-gray-50">
                                <td class="user-name font-medium">{{ object.username }}</td>
                                <td class="user-last-vote">{{ object.last_vote }}</td>
                                <td class="user-points" contenteditable="true">{{ object.points }}</td>
                                <td class="user-email" contenteditable="true">{{ object.email }}</td>
                                <td class="user-type-cell">
                                    <div class="flex items-center justify-between cursor-pointer" id="user-type">
                                        <span id="user-type-text">{{ object.user_type }}</span>
                                        <i class="fas fa-caret-down ml-2"></i>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <button id="apply-users-button" class="btn btn-primary w-full">
                    Apply User Changes
                </button>
            </div>
        </div>

        <!-- Movies Table -->
        <div class="card">
            <div class="card-header">
                <h2 class="text-xl font-semibold">Movies</h2>
            </div>
            <div class="card-content p-0">
                <div class="overflow-x-auto">
                    <table class="table" id="movies-table">
                        <thead>
                            <tr>
                                <th>Movie</th>
                                <th>Votes</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for object in movie_objects %}
                            <tr class="hover:bg-gray-50">
                                <td class="movie-name">
                                    <div class="font-medium">{{ object.movie }}</div>
                                </td>
                                <td class="movie-votes" contenteditable="true">{{ object.votes }}</td>
                                <td class="movie-category-cell">
                                    <div class="flex items-center justify-between cursor-pointer" id="movie-category">
                                        <span id="movie-category-text">{{ object.category }}</span>
                                        <i class="fas fa-caret-down ml-2"></i>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <button id="apply-movies-button" class="btn btn-primary w-full">
                    Apply Movie Changes
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<style>
/* Custom styles for contenteditable */
[contenteditable="true"] {
    border: 1px solid transparent;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: all 0.2s;
}

[contenteditable="true"]:hover {
    border-color: hsl(214.3, 31.8%, 91.4%);
}

[contenteditable="true"]:focus {
    outline: none;
    border-color: hsl(222.2, 84%, 4.9%);
    box-shadow: 0 0 0 2px hsla(222.2, 84%, 4.9%, 0.2);
}

.selected-item {
    background: hsl(210, 40%, 98%) !important;
    border-left: 4px solid hsl(222.2, 47.4%, 11.2%);
}

.dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid hsl(214.3, 31.8%, 91.4%);
    border-radius: 0.375rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    z-index: 50;
    max-height: 200px;
    overflow-y: auto;
}

.dropdown-item {
    padding: 0.5rem;
    cursor: pointer;
    transition: background 0.2s;
}

.dropdown-item:hover {
    background: hsl(210, 40%, 98%);
}
</style>

<script>
$(document).ready(function(){
    $('body').attr('spellcheck', false);

    // User type dropdown functionality
    $('#users-table').on('click', '#user-type', function(e){
        e.stopPropagation();
        $('.dropdown-menu').remove(); // Remove any existing dropdowns
        
        var dropdown_html = 
            '<div class="dropdown-menu mt-1">' +
                '<div class="dropdown-item selection"><span>user</span></div>' +
                '<div class="dropdown-item selection"><span>admin</span></div>' +
            '</div>';
        
        $(this).parent().css('position', 'relative').append(dropdown_html);
    });

    // User type dropdown selection
    $('#users-table').on('click', '.selection', function(e){
        e.stopPropagation();
        console.log('Changing user type');
        var dropdown_menu = $(this).parent();
        var changed_field = dropdown_menu.parent();
        var user_type = $(this).find('span').text();
        changed_field.find('#user-type-text').text(user_type);
        dropdown_menu.remove();
    });

    // Movie category dropdown functionality
    $('#movies-table').on('click', '#movie-category', function(e){
        e.stopPropagation();
        $('.dropdown-menu').remove(); // Remove any existing dropdowns
        
        var dropdown_html = 
            '<div class="dropdown-menu mt-1">' +
                '<div class="dropdown-item selection"><span>this week</span></div>' +
                '<div class="dropdown-item selection"><span>long wait</span></div>' +
                '<div class="dropdown-item selection"><span>archive</span></div>' +
            '</div>';
        
        $(this).parent().css('position', 'relative').append(dropdown_html);
    });

    // Movie category dropdown selection
    $('#movies-table').on('click', '.selection', function(e){
        e.stopPropagation();
        console.log('Changing movie category');
        var dropdown_menu = $(this).parent();
        var changed_field = dropdown_menu.parent();
        var category = $(this).find('span').text();
        changed_field.find('#movie-category-text').text(category);
        dropdown_menu.remove();
    });

    // Cell selection for editing
    $('#users-table td, #movies-table td').on('click', function(){
        if (!$(this).hasClass('user-type-cell') && !$(this).hasClass('movie-category-cell')){
            $('.dropdown-menu').remove();
        }
        $('td').removeClass('selected-item');
        $(this).addClass('selected-item');
    });

    // Deselect when clicking elsewhere
    $(document).on('click', function(e){
        var target = $(e.target);
        if (!target.is('td') && !target.closest('.dropdown-menu').length){
            $('.selected-item').removeClass('selected-item');
            $('.dropdown-menu').remove();
        }
    });

    // Refresh points
    $('#refresh-points').on('click', function(){
        $('.user-points').text('1');
    });

    // Refresh votes
    $('#refresh-votes').on('click', function(){
        $('.user-last-vote').text('None');
    });

    // Apply users changes
    $('#apply-users-button').on('click', function(){
        console.log('Submitting changes to the Users table');
        var user_dictionary = {};
        
        $('#users-table tr').each(function(i, row){
            if(i != 0){ // Skip header row
                var user_data = [];
                var row = $(row);
                row.find('br').remove(); // Fix br insertions from contenteditable
                
                var username = row.find('.user-name').text();
                var votes = row.find('.user-last-vote').text();
                var points = row.find('.user-points').html();
                var email = row.find('.user-email').html();
                var type = row.find('#user-type-text').text();
                
                user_data.push(username, votes, points, email, type);
                user_dictionary[username] = user_data;
            }
        });
        
        $.post('/updateusers', {'user_dictionary': JSON.stringify(user_dictionary)})
        .done(function(response) {
            console.log('Users updated successfully');
            // Show success message
            var successMsg = '<div class="p-3 bg-green-50 border border-green-200 rounded-lg mb-4"><p class="text-sm text-green-600">Users updated successfully!</p></div>';
            $('.container').prepend(successMsg);
            setTimeout(function(){ $('.bg-green-50').fadeOut(); }, 3000);
        })
        .fail(function() {
            console.log('Error updating users');
            // Show error message
            var errorMsg = '<div class="p-3 bg-red-50 border border-red-200 rounded-lg mb-4"><p class="text-sm text-red-600">Error updating users!</p></div>';
            $('.container').prepend(errorMsg);
            setTimeout(function(){ $('.bg-red-50').fadeOut(); }, 3000);
        });
    });

    // Apply movies changes
    $('#apply-movies-button').on('click', function(){
        console.log('Submitting changes to the Movies table');
        var movie_dictionary = {};
        
        $('#movies-table tr').each(function(i, row){
            if(i != 0){ // Skip header row
                var movie_data = [];
                var row = $(row);
                row.find('br').remove(); // Fix br insertions from contenteditable
                
                var movie = row.find('.movie-name').text().trim();
                var votes = row.find('.movie-votes').html();
                var category = row.find('#movie-category-text').text();
                
                movie_data.push(movie, votes, category);
                movie_dictionary[movie] = movie_data;
            }
        });
        
        $.post('/updatemovies', {'movie_dictionary': JSON.stringify(movie_dictionary)})
        .done(function(response) {
            console.log('Movies updated successfully');
            // Show success message
            var successMsg = '<div class="p-3 bg-green-50 border border-green-200 rounded-lg mb-4"><p class="text-sm text-green-600">Movies updated successfully!</p></div>';
            $('.container').prepend(successMsg);
            setTimeout(function(){ $('.bg-green-50').fadeOut(); }, 3000);
        })
        .fail(function() {
            console.log('Error updating movies');
            // Show error message
            var errorMsg = '<div class="p-3 bg-red-50 border border-red-200 rounded-lg mb-4"><p class="text-sm text-red-600">Error updating movies!</p></div>';
            $('.container').prepend(errorMsg);
            setTimeout(function(){ $('.bg-red-50').fadeOut(); }, 3000);
        });
    });
});
</script>
{% endblock %}